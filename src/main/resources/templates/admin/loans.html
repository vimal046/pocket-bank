<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<title>Loan Management - PocketBank Admin</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet" />
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
	rel="stylesheet" />
<style>
body {
	background: #f5f7fa;
	font-family: "Segoe UI";
}

.main-container {
	max-width: 1400px;
	margin: 0 auto;
	padding: 20px;
}

.card {
	border-radius: 12px;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	margin-bottom: 20px;
}
</style>
</head>
<body>
	<nav class="navbar navbar-expand-lg bg-dark navbar-dark">
		<div class="container-fluid main-container">
			<a class="navbar-brand" href="/admin/dashboard"><i
				class="bi bi-bank2"></i> PocketBank Admin</a>
			<div class="navbar-nav ms-auto">
				<a class="nav-link" href="/admin/dashboard">Dashboard</a> <a
					class="nav-link" href="/admin/users">Users</a> <a
					class="nav-link active" href="/admin/loans">Loans</a>
			</div>
		</div>
	</nav>

	<div class="main-container mt-4">
		<h2 class="mb-4">
			<i class="bi bi-cash-stack"></i> Loan Management
		</h2>

		<div th:if="${success}" class="alert alert-success alert-dismissible">
			<span th:text="${success}"></span>
			<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
		</div>

		<!-- Pending Loans -->
		<div class="card" th:if="${!pendingLoans.empty}">
			<div class="card-header bg-warning">
				<h5>
					<i class="bi bi-hourglass-split"></i> Pending Loan Applications (<span
						th:text="${pendingLoans.size()}"></span>)
				</h5>
			</div>
			<div class="card-body">
				<table class="table table-hover">
					<thead>
						<tr>
							<th>Applicant</th>
							<th>Loan Amount</th>
							<th>Tenure</th>
							<th>Interest Rate</th>
							<th>Monthly EMI</th>
							<th>Purpose</th>
							<th>Applied Date</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="loan : ${pendingLoans}">
							<td th:text="${loan.user.fullName}"></td>
							<td
								th:text="'₹' + ${#numbers.formatDecimal(loan.loanAmount, 0, 'COMMA', 2, 'POINT')}"></td>
							<td th:text="${loan.tenureMonths} + ' months'"></td>
							<td th:text="${loan.interestRate} + '%'"></td>
							<td
								th:text="'₹' + ${#numbers.formatDecimal(loan.monthlyEmi, 0, 'COMMA', 2, 'POINT')}"></td>
							<td th:text="${loan.purpose}"></td>
							<td th:text="${#temporals.format(loan.appliedAt, 'dd-MM-yyyy')}"></td>
							<td>
								<button class="btn btn-success btn-sm" data-bs-toggle="modal"
									th:data-bs-target="'#approveModal' + ${loan.id}">
									<i class="bi bi-check-circle"></i> Approve
								</button>
								<form th:action="@{'/admin/loans/' + ${loan.id} + '/reject'}"
									method="post" style="display: inline">
									<button type="submit" class="btn btn-danger btn-sm"
										onclick="return confirm('Are you sure you want to reject this loan?')">
										<i class="bi bi-x-circle"></i> Reject
									</button>
								</form> <!-- Approve Modal -->
								<div class="modal fade" th:id="'approveModal' + ${loan.id}"
									tabindex="-1">
									<div class="modal-dialog">
										<div class="modal-content">
											<div class="modal-header">
												<h5 class="modal-title">Approve Loan</h5>
												<button type="button" class="btn-close"
													data-bs-dismiss="modal"></button>
											</div>
											<form
												th:action="@{'/admin/loans/' + ${loan.id} + '/approve'}"
												method="post">
												<div class="modal-body">
													<p>
														<strong>Applicant:</strong> <span
															th:text="${loan.user.fullName}"></span>
													</p>
													<p>
														<strong>Loan Amount:</strong> <span
															th:text="'₹' + ${#numbers.formatDecimal(loan.loanAmount, 0, 'COMMA', 2, 'POINT')}"></span>
													</p>

													<div class="mb-3">
														<label class="form-label">Select Account for
															Disbursement</label> <select name="accountNumber"
															class="form-select" required>
															<option value="">Choose account...</option>
															<option th:each="acc : ${loan.user.accounts}"
																th:if="${acc.status.toString() == 'APPROVED'}"
																th:value="${acc.accountNumber}"
																th:text="${acc.accountType + ' - ' + acc.accountNumber}"></option>
														</select>
													</div>

													<div class="alert alert-info">
														<i class="bi bi-info-circle"></i> The loan amount will be
														credited to the selected account.
													</div>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-secondary"
														data-bs-dismiss="modal">Cancel</button>
													<button type="submit" class="btn btn-success">
														Approve & Disburse</button>
												</div>
											</form>
										</div>
									</div>
								</div>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<!-- All Loans -->
		<div class="card">
			<div class="card-header">
				<h5>
					<i class="bi bi-list-ul"></i> All Loans
				</h5>
			</div>
			<div class="card-body">
				<table class="table table-hover">
					<thead>
						<tr>
							<th>ID</th>
							<th>Applicant</th>
							<th>Loan Amount</th>
							<th>Tenure</th>
							<th>Interest Rate</th>
							<th>Monthly EMI</th>
							<th>Status</th>
							<th>Applied Date</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="loan : ${loans}">
							<td th:text="${loan.id}"></td>
							<td th:text="${loan.user.fullName}"></td>
							<td
								th:text="'₹' + ${#numbers.formatDecimal(loan.loanAmount, 0, 'COMMA', 2, 'POINT')}"></td>
							<td th:text="${loan.tenureMonths} + ' months'"></td>
							<td th:text="${loan.interestRate} + '%'"></td>
							<td
								th:text="'₹' + ${#numbers.formatDecimal(loan.monthlyEmi, 0, 'COMMA', 2, 'POINT')}"></td>
							<td><span class="badge"
								th:classappend="${loan.status.name() == 'APPROVED' or loan.status.name() == 'DISBURSED'
        ? 'bg-success'
        : loan.status.name() == 'PENDING'
        ? 'bg-warning'
        : 'bg-danger'}"
								th:text="${loan.status}"> </span></td>
							<td th:text="${#temporals.format(loan.appliedAt, 'dd-MM-yyyy')}"></td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
